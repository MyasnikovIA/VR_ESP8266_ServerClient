<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MPU6050 Sensor Data Monitor</title>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
        }
        
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-weight: bold;
        }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .sensors-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
        }
        .sensor-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
            transition: all 0.3s ease;
        }
        .sensor-card.inactive {
            opacity: 0.6;
            border-left-color: #95a5a6;
        }
        .sensor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .sensor-name {
            font-weight: bold;
            font-size: 1.1em;
            color: #2c3e50;
        }
        .sensor-status {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }
        .active { background: #d4edda; color: #155724; }
        .inactive { background: #f8d7da; color: #721c24; }
        .angle-display {
            margin: 10px 0;
        }
        .angle-label {
            font-weight: bold;
            color: #555;
        }
        .angle-value {
            float: right;
            font-family: monospace;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            margin-top: 5px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2980b9);
            transition: width 0.3s ease;
        }
        .connection-info {
            background: #34495e;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .log-container {
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
        }
        .hidden {
            display: none !important;
        }
        
        /* 3D Visualization Styles from index_v1.html */
        .visualization {
            background-color: var(--secondary-color);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .visualization h3 {
            color: white;
            text-align: center;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .cube-container {
            width: 120px;
            height: 120px;
            margin: 0 auto;
            perspective: 600px;
        }
        
        .cube {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.1s ease-out;
        }
        
        .face {
            position: absolute;
            width: 120px;
            height: 120px;
            border: 2px solid #34495e;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
            background: rgba(52, 152, 219, 0.8);
        }
        
        .front { transform: rotateY(0deg) translateZ(60px); background: rgba(231, 76, 60, 0.8); }
        .back { transform: rotateY(180deg) translateZ(60px); background: rgba(52, 152, 219, 0.8); }
        .right { transform: rotateY(90deg) translateZ(60px); background: rgba(46, 204, 113, 0.8); }
        .left { transform: rotateY(-90deg) translateZ(60px); background: rgba(155, 89, 182, 0.8); }
        .top { transform: rotateX(90deg) translateZ(60px); background: rgba(241, 196, 15, 0.8); }
        .bottom { transform: rotateX(-90deg) translateZ(60px); background: rgba(230, 126, 34, 0.8); }
        
        .device-controls {
            margin-top: 15px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .device-controls button {
            padding: 8px 12px;
            font-size: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .device-controls button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .notification.success {
            background-color: var(--success-color);
        }
        
        .notification.error {
            background-color: var(--danger-color);
        }
        
        .notification.info {
            background-color: var(--primary-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ MPU6050 Sensor Data Monitor</h1>
            <p>Real-time orientation data from multiple sensors</p>
        </div>

        <div class="connection-info">
            <div>WebSocket Status: <span id="wsStatus">Disconnected</span></div>
            <div>Active Sensors: <span id="sensorCount">0</span></div>
            <div>Server Time: <span id="serverTime">-</span></div>
        </div>

        <div id="status" class="status disconnected">
            üî¥ Disconnected from server
        </div>

        <div id="sensorsList" class="sensors-grid">
            <!-- Sensors will be dynamically added here -->
        </div>

        <div class="log-container">
            <div><strong>Connection Log:</strong></div>
            <div id="log"></div>
        </div>
    </div>

    <script>
        class SensorMonitor {
            constructor() {
                this.ws = null;
                this.sensors = new Map();
                this.reconnectInterval = 3000;
                this.init();
            }

            init() {
                this.connect();
                this.startServerTimeUpdate();
                this.startInactiveSensorCleanup();
            }

            connect() {
                try {
                    // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket —Å–µ—Ä–≤–µ—Ä—É ESP8266
                    this.ws = new WebSocket('ws://192.168.4.1:81');
                    
                    this.ws.onopen = () => {
                        this.updateStatus('üü¢ Connected to sensor server', true);
                        this.log('WebSocket connected successfully');
                        console.log('WebSocket connected');
                    };

                    this.ws.onmessage = (event) => {
                        this.handleMessage(event.data);
                    };

                    this.ws.onclose = () => {
                        this.updateStatus('üî¥ Disconnected from server', false);
                        this.log('WebSocket disconnected, attempting to reconnect...');
                        console.log('WebSocket disconnected');
                        setTimeout(() => this.connect(), this.reconnectInterval);
                    };

                    this.ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        this.updateStatus('üî¥ Connection error', false);
                        this.log('WebSocket connection error');
                    };

                } catch (error) {
                    console.error('Connection failed:', error);
                    this.log('Connection failed: ' + error.message);
                    setTimeout(() => this.connect(), this.reconnectInterval);
                }
            }

            handleMessage(data) {
                try {
                    // –ü—ã—Ç–∞–µ–º—Å—è –ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ JSON
                    const parsedData = JSON.parse(data);
                    this.processJSONMessage(parsedData);
                } catch (error) {
                    // –ï—Å–ª–∏ –Ω–µ JSON, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    this.processTextMessage(data);
                }
            }

            processJSONMessage(data) {
                switch(data.type) {
                    case 'sensor_list':
                        this.updateSensorList(data.sensors);
                        break;
                    case 'sensor_data':
                        this.updateSensorData(data);
                        break;
                    case 'connection':
                        this.log('Server: ' + data.message);
                        break;
                    default:
                        console.log('Unknown message type:', data);
                        this.log('Unknown message type: ' + data.type);
                }
            }

            processTextMessage(message) {
                this.log('Server message: ' + message);
            }

            updateSensorList(sensorsData) {
                const activeSensors = [];
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –º–∞—Å—Å–∏–≤ —Å–µ–Ω—Å–æ—Ä–æ–≤
                sensorsData.forEach(sensor => {
                    if (typeof sensor === 'object' && sensor.name) {
                        activeSensors.push(sensor.name);
                        this.ensureSensorExists(sensor.name);
                    } else if (typeof sensor === 'string') {
                        activeSensors.push(sensor);
                        this.ensureSensorExists(sensor);
                    }
                });

                document.getElementById('sensorCount').textContent = activeSensors.length;
                
                // –ü–æ–º–µ—á–∞–µ–º –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –¥–∞—Ç—á–∏–∫–∏ –∏ —Å–∫—Ä—ã–≤–∞–µ–º –∏—Ö
                this.sensors.forEach((sensor, sensorName) => {
                    if (!activeSensors.includes(sensorName)) {
                        this.markSensorInactive(sensorName);
                    } else {
                        this.markSensorActive(sensorName);
                    }
                });
            }

            ensureSensorExists(sensorName) {
                if (!this.sensors.has(sensorName)) {
                    this.addSensor(sensorName);
                }
            }

            addSensor(sensorName) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –∫–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è —ç—Ç–æ–≥–æ –¥–∞—Ç—á–∏–∫–∞
                const existingCard = document.getElementById(this.getSensorCardId(sensorName));
                if (existingCard) {
                    // –ï—Å–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë
                    this.sensors.set(sensorName, {
                        element: existingCard,
                        lastUpdate: Date.now(),
                        active: true,
                        pitch: 0,
                        roll: 0,
                        yaw: 0,
                        cubeElement: null
                    });
                    this.markSensorActive(sensorName);
                } else {
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–∞—Ä—Ç–æ—á–∫—É
                    const element = this.createSensorElement(sensorName);
                    this.sensors.set(sensorName, {
                        element: element,
                        lastUpdate: Date.now(),
                        active: true,
                        pitch: 0,
                        roll: 0,
                        yaw: 0,
                        cubeElement: document.getElementById(this.getSensorCubeId(sensorName))
                    });
                }
                this.log('Sensor added: ' + sensorName);
            }

            createSensorElement(sensorName) {
                const grid = document.getElementById('sensorsList');
                const card = document.createElement('div');
                card.className = 'sensor-card';
                card.id = this.getSensorCardId(sensorName);
                card.innerHTML = `
                    <div class="sensor-header">
                        <div class="sensor-name">${this.escapeHtml(sensorName)}</div>
                        <div class="sensor-status active">ACTIVE</div>
                    </div>
                    <div class="angle-display">
                        <div class="angle-label">Pitch: <span class="angle-value" id="${this.getSensorElementId(sensorName, 'pitch')}">0.00¬∞</span></div>
                        <div class="progress-bar"><div class="progress-fill" id="${this.getSensorElementId(sensorName, 'pitch-bar')}" style="width: 50%"></div></div>
                    </div>
                    <div class="angle-display">
                        <div class="angle-label">Roll: <span class="angle-value" id="${this.getSensorElementId(sensorName, 'roll')}">0.00¬∞</span></div>
                        <div class="progress-bar"><div class="progress-fill" id="${this.getSensorElementId(sensorName, 'roll-bar')}" style="width: 50%"></div></div>
                    </div>
                    <div class="angle-display">
                        <div class="angle-label">Yaw: <span class="angle-value" id="${this.getSensorElementId(sensorName, 'yaw')}">0.00¬∞</span></div>
                        <div class="progress-bar"><div class="progress-fill" id="${this.getSensorElementId(sensorName, 'yaw-bar')}" style="width: 50%"></div></div>
                    </div>
                    <div class="visualization">
                        <h3>3D Sensor Visualization</h3>
                        <div class="cube-container">
                            <div class="cube" id="${this.getSensorCubeId(sensorName)}">
                                <div class="face front">FRONT</div>
                                <div class="face back">BACK</div>
                                <div class="face right">RIGHT</div>
                                <div class="face left">LEFT</div>
                                <div class="face top">TOP</div>
                                <div class="face bottom">BOTTOM</div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.8em; color: #666;">
                        Last update: <span id="${this.getSensorElementId(sensorName, 'time')}">Just now</span>
                    </div>
                    <div class="device-controls">
                        <button class="btn-success" onclick="sensorMonitor.sendDeviceCommand('${sensorName}', 'SET_ZERO')">Set Zero</button>
                        <button class="btn-warning" onclick="sensorMonitor.sendDeviceCommand('${sensorName}', 'CALIBRATE')">Calibrate</button>
                        <button class="btn-danger" onclick="sensorMonitor.sendDeviceCommand('${sensorName}', 'RESET_ANGLES')">Reset</button>
                    </div>
                `;
                grid.appendChild(card);
                return card;
            }

            updateSensorData(data) {
                if (!data.sensor) {
                    console.error('Invalid sensor data:', data);
                    return;
                }

                const sensorName = data.sensor;
                this.ensureSensorExists(sensorName);
                
                const sensor = this.sensors.get(sensorName);
                if (sensor) {
                    sensor.lastUpdate = Date.now();
                    sensor.active = true;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è —É–≥–ª–æ–≤ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ —É–≥–ª—ã)
                    const pitch = data.pitch || 0;
                    const roll = data.roll || 0;
                    const yaw = data.yaw || 0;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —É–≥–ª—ã –¥–ª—è 3D –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
                    sensor.pitch = pitch;
                    sensor.roll = roll;
                    sensor.yaw = yaw;
                    
                    this.updateAngleDisplay(sensorName, 'pitch', pitch);
                    this.updateAngleDisplay(sensorName, 'roll', roll);
                    this.updateAngleDisplay(sensorName, 'yaw', yaw);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è
                    const timeElement = document.getElementById(this.getSensorElementId(sensorName, 'time'));
                    if (timeElement) {
                        timeElement.textContent = new Date().toLocaleTimeString();
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º 3D –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
                    this.updateCubeVisualization(sensorName);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                    this.markSensorActive(sensorName);
                    
                    // –õ–æ–≥–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
                    if (pitch !== 0 || roll !== 0 || yaw !== 0) {
                        this.log(`Sensor ${sensorName} updated: P=${pitch.toFixed(2)}¬∞, R=${roll.toFixed(2)}¬∞, Y=${yaw.toFixed(2)}¬∞`);
                    }
                }
            }

            updateAngleDisplay(sensorName, axis, value) {
                const valueElement = document.getElementById(this.getSensorElementId(sensorName, axis));
                const barElement = document.getElementById(this.getSensorElementId(sensorName, axis + '-bar'));
                
                if (valueElement) {
                    valueElement.textContent = `${value.toFixed(2)}¬∞`;
                }
                
                if (barElement) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä (–Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –æ—Ç -180 –¥–æ 180 –¥–æ 0-100%)
                    const normalizedValue = Math.max(0, Math.min(100, ((Number(value) + 180) / 360) * 100));
                    barElement.style.width = `${normalizedValue}%`;
                }
            }

            updateCubeVisualization(sensorName) {
                const sensor = this.sensors.get(sensorName);
                if (sensor && sensor.cubeElement) {
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Ä–∞—â–µ–Ω–∏–µ –∫ –∫—É–±—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —É–≥–ª–æ–≤ –¥–∞—Ç—á–∏–∫–∞
                    sensor.cubeElement.style.transform = 
                        `rotateX(${sensor.roll}deg) rotateY(${sensor.yaw}deg) rotateZ(${sensor.pitch}deg)`;
                }
            }

            markSensorActive(sensorName) {
                const sensor = this.sensors.get(sensorName);
                if (sensor && sensor.element) {
                    sensor.active = true;
                    sensor.element.classList.remove('inactive', 'hidden');
                    const statusElement = sensor.element.querySelector('.sensor-status');
                    if (statusElement) {
                        statusElement.className = 'sensor-status active';
                        statusElement.textContent = 'ACTIVE';
                    }
                }
            }

            markSensorInactive(sensorName) {
                const sensor = this.sensors.get(sensorName);
                if (sensor && sensor.element) {
                    sensor.active = false;
                    sensor.element.classList.add('inactive');
                    const statusElement = sensor.element.querySelector('.sensor-status');
                    if (statusElement) {
                        statusElement.className = 'sensor-status inactive';
                        statusElement.textContent = 'INACTIVE';
                    }
                    this.log('Sensor inactive: ' + sensorName);
                }
            }

            removeInactiveSensors() {
                const inactiveTimeout = 30000; // 30 —Å–µ–∫—É–Ω–¥
                const currentTime = Date.now();
                
                this.sensors.forEach((sensor, sensorName) => {
                    if (!sensor.active && (currentTime - sensor.lastUpdate > inactiveTimeout)) {
                        if (sensor.element) {
                            sensor.element.remove();
                        }
                        this.sensors.delete(sensorName);
                        this.log('Sensor removed: ' + sensorName);
                    }
                });
            }

            sendDeviceCommand(sensorName, command) {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    const message = JSON.stringify({
                        type: 'device_command',
                        sensor: sensorName,
                        command: command
                    });
                    this.ws.send(message);
                    this.log(`Command sent to ${sensorName}: ${command}`);
                    this.showNotification(`Command sent to ${sensorName}`, 'info');
                } else {
                    this.showNotification('Not connected to server', 'error');
                }
            }

            getSensorCardId(sensorName) {
                // –°–æ–∑–¥–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–π ID –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏
                return 'sensor-' + this.escapeHtml(sensorName).replace(/[^a-zA-Z0-9-_]/g, '-');
            }

            getSensorCubeId(sensorName) {
                return this.getSensorCardId(sensorName) + '-cube';
            }

            getSensorElementId(sensorName, elementType) {
                // –°–æ–∑–¥–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–π ID –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏
                return this.getSensorCardId(sensorName) + '-' + elementType;
            }

            escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            updateStatus(message, isConnected) {
                const statusElement = document.getElementById('status');
                statusElement.textContent = message;
                statusElement.className = `status ${isConnected ? 'connected' : 'disconnected'}`;
                document.getElementById('wsStatus').textContent = 
                    isConnected ? 'Connected' : 'Disconnected';
            }

            log(message) {
                const logElement = document.getElementById('log');
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.textContent = `[${timestamp}] ${message}`;
                logElement.appendChild(logEntry);
                
                // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
                logElement.scrollTop = logElement.scrollHeight;
                
                // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –ª–æ–≥–µ
                if (logElement.children.length > 50) {
                    logElement.removeChild(logElement.firstChild);
                }
            }

            showNotification(message, type) {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }

            startServerTimeUpdate() {
                setInterval(() => {
                    document.getElementById('serverTime').textContent = 
                        new Date().toLocaleTimeString();
                }, 1000);
            }

            startInactiveSensorCleanup() {
                setInterval(() => {
                    this.removeInactiveSensors();
                }, 10000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
            }
        }

        // –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            window.sensorMonitor = new SensorMonitor();
        });
    </script>
</body>
</html>